<extend name="Public:header"/>
<block name="main">

    <div class="body1">

    <div class="header-container colfff">
        <div class="weui-cell ih30">
            <div class="weui-cell__bd">
                <p>商家注册</p>
            </div>
        </div>
    </div>

    <div class="xq_container">
       <div class="weui-cells bgfff outinput">
            <div class="weui-cell">
                <div class="weui-cell__hd mar15">
                    手机号
                </div>
                <div class="weui-cell__bd">
                    <input class="weui-input account" type="tel" placeholder="手机号"/>
                </div>
            </div>

             <div class="weui-cell">
                <div class="weui-cell__hd mar15">
                    图形码
                </div>

                <div class="weui-cell__bd">
                    <input class="weui-input verify_code" type="text" placeholder="请输入图形码"/>
                </div>
                <div class="weui-cell__ft">
                    <img class="changevirify" src="{:U('Api/Login/verify')}" style="height:30px"/>
                </div>
            </div>

            <div class="weui-cell">
                <div class="weui-cell__hd mar15">
                    验证码
                </div>

                <div class="weui-cell__bd">
                    <input class="weui-input vc" type="text" placeholder="请输入验证码"/>
                </div>
                <div class="weui-cell__ft colff0 getcode">获取验证码</div>
            </div>

            <div class="weui-cell">
                <div class="weui-cell__hd mar15">
                    密码
                </div>

                <div class="weui-cell__bd">
                    <input class="weui-input password" type="password" placeholder="请输入密码"/>
                </div>
            </div>

            <div class="weui-cell">
                <div class="weui-cell__hd mar15">
                    确认密码
                </div>

                <div class="weui-cell__bd">
                    <input class="weui-input repassword" type="password" placeholder="请确认密码"/>
                </div>
            </div>

            <div class="weui-cell">
                <div class="weui-cell__hd mar15">
                    商家名
                </div>
                <div class="weui-cell__bd">
                    <input class="weui-input name" type="text" placeholder="请输入您的店名"/>
                </div>
            </div>

            <div class="weui-cell weui-cell_select ding_pad">
                <div class="weui-cell__hd mar15">
                    分类
                </div>
                <div class="weui-cell__bd">
                    <select class="weui-select d_classlist" name="d_classlist">
                        
                    </select>
                </div>
            </div>

            <div class="weui-cell weui-cell_access body2but">
                    <div class="weui-cell__bd">
                        <p class="">选择省市区</p>
                    </div>
                    <div class="weui-cell__ft d_list1 fs0-8">选择省市区</div>
            </div>

            <div class="weui-cell weui-cell_access showmap">
                    <div class="weui-cell__bd">
                        <p class="w70">详细地址</p>
                    </div>
                    <div class="weui-cell__ft d_list1 d_addressmain">选择详细地址</div>
            </div>

            <div class="weui-cell">
                <div class="weui-cell__hd mar15">
                    法人姓名
                </div>
                <div class="weui-cell__bd">
                    <input class="weui-input legal_person" type="text" placeholder="请输入真实姓名"/>
                </div>
            </div>

            <div class="weui-cell">
                <div class="weui-cell__hd mar15">
                    身份证号
                </div>
                <div class="weui-cell__bd">
                    <input class="weui-input id_number" type="text" placeholder="请输入真实身份证号"/>
                </div>
            </div>

            <div class="weui-cell">
                <div class="weui-cell__hd mar15">
                    企业邮箱
                </div>
                <div class="weui-cell__bd">
                    <input class="weui-input email" type="email" placeholder="请输入邮箱"/>
                </div>
            </div>

            <div class="weui-cell">
                <div class="weui-cell__hd mar15">
                    推荐人
                </div>
                <div class="weui-cell__bd">
                    <input class="weui-input tel" type="tel" placeholder="推荐人手机号"/>
                </div>
            </div>
            
            <div class="weui-cell">
                <div class="weui-cell__hd mar15">
                    <div>上传资质</div>
                    <div class="fs0-8 colff0">(营业执照、门头照等相关资质)</div>
                </div>
                <div class="weui-cell__bd weui-uploader__bd">
                    <ul class="weui-uploader__files" id="uploaderFiles">
                        <!-- <li class="weui-uploader__file weui-uploader__file_status" style="background-image:url(./images/pic_160.png)">
                            <div class="weui-uploader__file-content">
                                <i class="weui-icon-warn remove"></i>
                            </div>
                        </li>
                        <li class="weui-uploader__file weui-uploader__file_status" style="background-image:url(./images/pic_160.png)">
                            <div class="weui-uploader__file-content">50%</div>
                        </li> -->
                    </ul>
                    <div class="weui-uploader__input-box">
                        <input id="uploaderInput" onchange="mychange(this)" class="weui-uploader__input" type="file" accept="image/*" multiple />
                    </div>
                </div>
            </div>
        </div>
        <div class="weui-btn-area ok">
            <a class="weui-btn bgjb nobor loginbtn" href="javascript:">注册</a>
        </div>

        <div id="containerbox" style="width: 100vw;height: 100vh;position: fixed;top: 0px;z-index: 50;padding-bottom: 50px;">
            <div id="container" style="width: 100vw;height:100%;z-index: 50">
                <div class ='panel'>
                    <input id = 'input' placeholder = '点击地图显示地址/输入地址显示位置'></input>
                    <div id = 'message'></div>
                </div>
                <div class="mapok">确定</div>
            </div>
            <div class="closemap">
                关闭
            </div>
        </div>
        
        
    </div>
    </div>

    <div class="body2">
        <div class="header-container colfff">
            <div class="weui-cell ih30">
                <div class="weui-cell__bd dtopback">
                    <p>返回</p>
                </div>
            </div>
        </div> 

        <div class="xq_container">
            <div class="weui-cells body2list">
            </div>
        </div>

    </div>

</block>
<block name="footerjs">
    <script type="text/javascript" src="https://webapi.amap.com/maps?v=1.3&key=c5e14c05b9c3aef7d437cb31cda7313f&plugin=AMap.Autocomplete">
</script>
    <script>

    // 点击省市区
    $('.body2list').on('click','.weui-cell',function(){
        if(getarr.length==0){
            getsheng(2,{'province':$(this).attr('area_id')});
            getarr.push({'name':$(this).attr('area_name'),'id':$(this).attr('area_id')});
        }else if(getarr.length==1){
            getsheng(3,{'city':$(this).attr('area_id')});
            getarr.push({'name':$(this).attr('area_name'),'id':$(this).attr('area_id')});
        }else if(getarr.length==2){
            getarr.push({'name':$(this).attr('area_name'),'id':$(this).attr('area_id')});
            $('.body1').removeClass('none');
            $('.body2but .weui-cell__ft').html(getarr[0].name+'>>'+getarr[1].name+'>>'+getarr[2].name);
        }
    });

    // 返回
    $('.body2 .header-container').click(function(){
        if(getarr.length==0){
            $('.body1').removeClass('none');
        }else if(getarr.length==1){
            getsheng(1);
            getarr=[];
        }else if(getarr.length==2){
            getsheng(2,{'province':getarr[1].id});
            getarr.pop();
        }
    })

    var getarr=[];
    $('.body2but').click(function(){
        $('.body1').addClass('none');
        getsheng(1);
    });

    // 获取省级num:1省2市3区
    function getsheng(num,fundata){
        var urldata=(num==1?'getProvince':(num==2?'getCity':'getArea'));
        requestUrl("{:U('Api/Merchant/"+urldata+"')}",fundata,function(res) {
                if (res.flag == "success") {
                    var info=res.data;
                    var str="";
                    for(var i=0;i<info.length;i++){
                        str+='<div area_id='+info[i].area_id+' area_name='+info[i].area_name+' class="weui-cell '+(num==3?'weui-cell_access':'')+'">'+
                        '<div class="weui-cell__bd">'+
                            '<p>'+info[i].area_name+'</p>'+
                        '</div>'+
                    '</div>';
                    }
                    $(".body2list").html(str);
                }else{
                    layer.msg(res.message);
                }
        },num==1?"GET":"POST");
    }


    //高德地图
     $('.showmap').click(function () {
        console.log(123);
        $('#containerbox').show();
        $('#container').show();
    })
    var lat='';
    var lng='';
    var myaddress="";//详细地址
    var map = new AMap.Map('container',{
            resizeEnable: true,
            zoom: 13,
            // center: [116.39,39.9]
    });

    //定位
     map.plugin('AMap.Geolocation', function() {
        geolocation = new AMap.Geolocation({
            enableHighAccuracy: true,//是否使用高精度定位，默认:true
            timeout: 10000,          //超过10秒后停止定位，默认：无穷大
            buttonOffset: new AMap.Pixel(10, 20),//定位按钮与设置的停靠位置的偏移量，默认：Pixel(10, 20)
            zoomToAccuracy: false,      //定位成功后调整地图视野范围使定位位置及精度范围视野内可见，默认：false
            buttonPosition:'RB'
        });
        map.addControl(geolocation);
        geolocation.getCurrentPosition();
        AMap.event.addListener(geolocation, 'complete', onComplete);//返回定位信息
        AMap.event.addListener(geolocation, 'error', onError);      //返回定位出错信息
    });

    //解析定位结果
    function onComplete(data) {
        $('#input').val(data.formattedAddress);
        myaddress=data.formattedAddress;
        $('.d_addressmain').html(myaddress);
        lat=data.position.lat;
        lng=data.position.lng;
    }
    //解析定位错误信息
    function onError(data) {
        console.log(data);
    }



    AMap.plugin('AMap.Geocoder',function(){
        var geocoder = new AMap.Geocoder({
            // city: "010"//城市，默认：“全国”
        });
        var marker = new AMap.Marker({
            map:map,
            bubble:true
        })
        var input = document.getElementById('input');
        var message = document.getElementById('message');
        map.on('click',function(e){
            console.log(e);
            lat=e.lnglat.lat;
            lng=e.lnglat.lng;
            marker.setPosition(e.lnglat);
            geocoder.getAddress(e.lnglat,function(status,result){
              if(status=='complete'){
                 input.value = result.regeocode.formattedAddress;
                 myaddress= result.regeocode.formattedAddress;
                 message.innerHTML = '';
              }else{
                 message.innerHTML = '无法获取地址';
              }
            })
        })
        
        input.onchange = function(e){
            var address = input.value;
            geocoder.getLocation(address,function(status,result){
                console.log(status);
                console.log(result);
              if(status=='complete'&&result.geocodes.length){
                lat=result.geocodes[0].location.lat;
                lng=result.geocodes[0].location.lng;
                myaddress=result.geocodes[0].formattedAddress;
                marker.setPosition(result.geocodes[0].location);
                map.setCenter(marker.getPosition());
                message.innerHTML = ''
              }else{
                message.innerHTML = '无法获取位置'
              }
            })
        }

    });

    $('.mapok,.closemap').click(function (e) {
        e.stopPropagation();
        $('.d_addressmain').html(myaddress);
        $('#containerbox').hide();
        $('#container').hide();
    });


    // 图片数组
    var imgarr=[];
    // 点击添加图片
    function mychange (data) {
        var fileimg=data.files; 
        var arrnum=imgarr.length;
        var num=arrnum+fileimg.length;
        if(num>3){
            layer.msg("最多上传三张图片");
            return false;
        }
        for(var i =0;i<fileimg.length;i++){    
            /*图片转Base64 核心代码*/  
            var file = fileimg[i];  
            //这里我们判断下类型如果不是图片就返回 去掉就可以上传任意文件  
            if (!/image\/\w+/.test(file.type)) {  
                layer.msg("请确保文件为图像类型");  
                return false;  
            }  
            var reader = new FileReader(); 
            (function(x){
                reader.onload = function (e) {  
                var str='<li class="weui-uploader__file " style="background-image:url('+this.result+')"><span class="remove" style="color:red">X</span></li>';
                $("#uploaderFiles").append(str);
                render(this.result,x);
                }  
            })(file.name);
            reader.readAsDataURL(file); 
        }
     };


     var MAX_HEIGHT = 1000;
// 渲染
function render(src,picname) {
    // 创建一个 Image 对象
    var image = new Image();
    // 绑定 load 事件处理器，加载完成后执行
    image.onload = function() {
        // 获取 canvas DOM 对象
        var canvas = document.createElement("canvas");
        // 如果高度超标
        if (image.height > MAX_HEIGHT && image.height >= image.width) {
            // 宽度等比例缩放 *=
            image.width *= MAX_HEIGHT / image.height;
            image.height = MAX_HEIGHT;
        }
        if (image.width > MAX_HEIGHT && image.width > image.height) {
            // 宽度等比例缩放 *=
            image.height *= MAX_HEIGHT / image.width;
            image.width = MAX_HEIGHT;
        }
        // 获取 canvas的 2d 环境对象,
        // 可以理解Context是管理员，canvas是房子
        var ctx = canvas.getContext("2d");
        // canvas清屏
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        // 重置canvas宽高
        canvas.width = image.width;
        canvas.height = image.height;
        // 将图像绘制到canvas上
        ctx.drawImage(image, 0, 0, image.width, image.height);
        // !!! 注意，image 没有加入到 dom之中
//        document.getElementById('img').src = canvas.toDataURL("image/png");
        var blob = canvas.toDataURL("image/jpeg");
        imgarr.push({"pic":blob,"pic_name":picname});
        // var fd = new FormData();
        // fd.append("image", blob, "image.png");
        // imgCompressUpload(canvas.toDataURL("image/png"));
       
    };
    // 设置src属性，浏览器会自动加载。
    // 记住必须先绑定事件，才能设置src属性，否则会出同步问题。
    image.src = src;
};

     // 点击删除图片
     $("#uploaderFiles").on("click",".remove",function(){
        $(this).parent().remove();
        $("#uploaderInput").remove();
        var str="<input id='uploaderInput' onchange='mychange(this)' class='weui-uploader__input' type='file' accept='image/*' multiple />";
        $(".weui-uploader__input-box").append(str);
        imgarr.splice($(this).index()-1,1); 
     })

    // 添加分类
    requestUrl("{:U('Api/Shop/classList')}",{},function(res) {
       layer.closeAll();

        if (res.flag == "success") {
            var info=res.data;
            for(var i=0;i<info.length;i++){
                 var str='<option value='+info[i].class_id+'>'+info[i].name+'</option>';
                 $(".d_classlist").append(str);
            }
        }else{
            layer.msg(res.message);
        }
    },"POST",true)

    // 获取验证码
    getCode("{:U('Api/Login/sendVerify')}","register",1);
        var curind = 0;
        var url = "{:U('Api/Login/verify')}";
        $(".changevirify").on('click',function () {
            curind++;
            $(this).attr("src",url+"/"+curind);
    });
     // 注册
     $(".ok").click(function(){
        var account = $(".account").val();
        var vc = $(".vc").val();
        var password = $(".password").val();
        var repassword = $(".repassword").val();
        var name = $(".name").val();
        var tel = $(".tel").val();
        var classid = $(".d_classlist").val();

        var legal_person = $(".legal_person").val();
        var id_number = $(".id_number").val();
        var email = $(".email").val();

        if(imgarr.length<1){
           layer.msg("最少上传一张图片");
           return;
        }else if(!account||!vc||!password||!repassword||!name){
           layer.msg("信息不能为空");
           return;
        }else if(password!=repassword){
           layer.msg("两次输入密码不一致");
           return;
        }else if(getarr.length!=3){
            layer.msg("请选择省市区");
           return;
        }else if(!myaddress){
            layer.msg("请选择详细地址");
           return;
        }
        var dingdata={"account":account,"name":name,"password":password,"re_password":repassword,"recommend":tel,"vc":vc,"pic":imgarr,"class_id":classid,"lnt":lng,"lat":lat,"address":myaddress,"province":getarr[0].id,"city":getarr[1].id,"area":getarr[2].id};
        var reg = /^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+(.[a-zA-Z0-9_-])+/;
        if (!legal_person){
            layer.msg("请填写法人姓名");
            return;
        }else if(!/\d{17}[\d|X|x]{1}/.test(id_number)){
            layer.msg("请核对身份证号！");
            return;
        }else if(!reg.test(email) ) {
            layer.msg("请核对您的邮箱！");
            return;
        }
        dingdata.legal_person = legal_person;
        dingdata.id_number = id_number;
        dingdata.email = email;

        requestUrl("{:U('Api/Merchant/shopRegister')}",dingdata,function(res) {
           layer.msg(res.message);
            if (res.flag == "success") {
                 alert("签订合同，加速审核速度！");
                 goSign(res.data.shop_id);
            }else{
                
            }
        },"POST",true) 
     })

     function goSign (shop_id) {
         requestUrl("{:U('Api/Ht/sign')}",{shop_id,shop_id},function ( res ) {
            if ( res.flag == "success" ) {
                window.location.href = res.data;
            }else{
                layer.msg( res.message );
            }
         })
     }
    </script>
</block>