<extend name="Public:head"/>
<block name="main">
	<!-- 头部 -->
    <div class="header-container bgfff z3">
            <div class="weui-cell ih30 box">
                <div class="weui-cell__hd">
                </div>
                <div class="weui-cell__bd textcenter">
                    <!-- <div class="addressback" linkto="{:U('Car/car')}"><img class="w100" src="__WEBPUBLIC__/Wechat/img/back.png"></div> -->
                	确认订单
                	<!-- <span class="fr tc">退出</span> -->
                </div>
                <!--<div class="weui-cell__ft">
                    <img src="/Public/Wechat/img/fenx.png" class="iconfenx"/>
                </div>-->
            </div>
    </div>
    <!-- 内容 -->
    <div class="xq_container padb50">
        <div class="flex bgfff pad10 cordertop">
            <div class="flex flexcenter mgr10">
                <img class="w15" src="/Public/Wechat/cusimg/img (1).png">
            </div>
            <div class="flex1 fs14">
                <div class="flex">
                    <div class="w65">收货人:</div>
                    <div class="flex1"><span class="mgr5 name"></span><span class="tel"></span></div>
                </div>
                <div class="flex">
                    <div class="w65">收货地址:</div>
                    <div class="flex1 address"></div>
                </div>
            </div>
            <div class="flex flexcenter">
                <img class="w15" src="/Public/Wechat/cusimg/img (20).png">
            </div>
        </div>
        <div class="corderlist mgtop20">
            <!-- <div class="corderitem mgb20 bgfff">
                <div class="corderitemtop pad10 ih30">
                    <img class="w15" src="/Public/Wechat/cusimg/img (6).png">
                    <span>asdjk暗红色的</span>
                    <img class="w15" src="/Public/Wechat/cusimg/img (20).png">
                    <span class="right corderlq">领券</span>
                </div>
                <div class="">
                    <div class="flex corderitemshop">
                            <div class="carshopimg">
                                <img class="w100" src="/Public/Wechat/cusimg/img (86).png">
                            </div>
                            <div class="flex1 ih20 fs14">
                                <div class="carshoptab1">
                                    <div class="line2 h40">按时间段阿萨德看来就阿萨德阿萨德；阿斯达卡asdasdasd阿萨德点击我剪短发阿斯兰的接口打开</div>
                                    <div class="colb6 fs12">
                                        M；xxl；黑色 M；xxl
                                    </div>
                                    <div>
                                        <span class="colred">￥159.02</span>
                                        <span class="right colb6">x1</span>
                                    </div>
                                </div>
                            </div>
                    </div>
                    <div class="flex corderitemshop">
                            <div class="carshopimg">
                                <img class="w100" src="/Public/Wechat/cusimg/img (86).png">
                            </div>
                            <div class="flex1 ih20 fs14">
                                <div class="carshoptab1">
                                    <div class="line2 h40">按时间段阿萨德看来就阿萨德阿萨德；阿斯达卡asdasdasd阿萨德点击我剪短发阿斯兰的接口打开</div>
                                    <div class="colb6 fs12">
                                        M；xxl；黑色 M；xxl
                                    </div>
                                    <div>
                                        <span class="colred">￥159.02</span>
                                        <span class="right colb6">x1</span>
                                    </div>
                                </div>
                            </div>
                    </div>
                </div>
                <div class="corderitemfoot fs14">
                    <div class="weui-cell">
                        <div class="weui-cell__bd">
                            <p>配送方式</p>
                        </div>
                        <div class="weui-cell__ft"><span class="mgr5">快递</span>运费￥<span>18</span></div>
                    </div>
                    <div class="weui-cell">
                        <div class="weui-cell__bd">
                            <p>支付方式</p>
                        </div>
                        <div class="weui-cell__ft"><span>在线支付</span></div>
                    </div>
                    <div class="weui-cell">
                        <div class="weui-cell__bd">
                            <p>优惠券</p>
                        </div>
                        <div class="weui-cell__ft"><span>暂无优惠券可用</span></div>
                    </div>
                    <div class="weui-cell">
                        <div class="weui-cell__bd">
                            <textarea class="weui-textarea" placeholder="买家留言(选填)" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="textright">
                        <span class="">共48件商品</span>
                        小计:<span class="colred">￥185.05</span>
                    </div>
                </div>
            </div> -->
        </div>

        <div class="bgfff mgb10">
            <div class="after padtb10">
                <div class="weui-cell weui-cell_switch">
                    <div class="weui-cell__bd">
                        <div class="colblack">
                        众享豆抵用 <span class="colred dounum"></span>
                        </div>
                        <div class="fs12 colb6">
                            (剩余 <span class="wallet"></span>众享豆)
                        </div>
                    </div>
                    <div class="weui-cell__ft">
                        <input class="weui-switch paytype" checked type="checkbox"/>
                    </div>
                </div>
            </div>
             <div class="flex choosecoupon">
                <div class="flex1 textovh pad10">
                    <div class="colblack">
                        使用平台优惠券
                    </div>
                    <div class="fs14 colb6 couponname textovh">
                       
                    </div>
                </div>
                <div class="flex flexvcenter mgr10">
                    <img class="w20" src="/Public/Wechat/cusimg/img (20).png">
                </div>
            </div>        
           <!--  <div class="flex">
                <div class="flex1 pad10">
                    <div class="colblack">
                        使用平台优惠券
                    </div>
                    <div class="fs14 colb6">
                        服装类满100减10
                    </div>
                </div>
                <div class="checkdiv flex flexvcenter">
                        <input type="checkbox" name="">
                        <span></span>
                </div>
            </div>     -->
        </div>

        <div class="corderfoot fs14 pad10 flex bgfff">
            <div>收货地址:</div>
            <div class="flex1 address"></div>
        </div>
    </div>

    <!-- 脚部 -->
        <div class="carfoot flex z3">
            <div class="carfootl flex1">
                <div class="carfootlb h100 flex flexvcenter">
                    合计:<span class="colred total"></span>
                </div>
            </div>
            <div class="carfootr">
                提交订单
            </div>
        </div>

    <!-- 商品优惠券详情 -->
        <div id="actionSheet_wrap2" style="display: none;">
            <div class="weui-mask_transparent actionsheet__mask bg0-6"  style="opacity: 1" id="mask2"></div>
            <div class="weui-actionsheet weui-actionsheet_toggle" id="weui-actionsheet2">
                <div class="weui-actionsheet__menu myweuilq pad10">
                   <div class="myweuilqtop">
                        <div class="myweuilqname fs14">平台优惠券</div>
                        <div><b class="colblack">领取优惠券</b></div>
                   </div>
                   <div class="myweuilqmain">
                    <div>
                        <!-- <div class="flex lqbox lqbox1">
                            <div class="flex1 flex lqleft textovh">
                                <div class="flex flexcenter mgr5">
                                    ￥ <span class="fs35">10</span>
                                </div>
                                <div class="flex1 textovh fs14">
                                    <div>优惠券</div>
                                    <div>实付满199可用</div>
                                    <div class="fs12 textovh">(<span>2017.08.09-2019.02.06</span><span>全场可用</span>)</div>
                                </div>
                            </div>
                            <div class="lqright flex flexcenter">
                                <span class="">点击领取</span>
                            </div>
                        </div> -->
                    </div>             
                   </div>

                </div>
                <div class="weui-actionsheet__action">
                    <div class="weui-actionsheet__cell myweuiok2" id="actionsheet_cancel2">关闭</div>
                </div>
            </div>
        </div>


</block>
<block name="footerjs">
<script type="text/javascript">
    var mycart_id="{$_GET['cart_id']}";
    var addr_id="{$_GET['addr_id']}";//地址id
    var isok=true;//提交订单是否可以点击
    var mydata={m_id:m_id,detail:[],is_wallet:1,cart_id:[]};//提交订单参数
    var paynum={}; //wallet为剩余豆，total为总金额(减去优惠券)，oldtotal为原始总价格，type：0为豆多，大于0为总价多是差价，
    var coupon="";//优惠券
    console.log(mycart_id);
    var datas={m_id:m_id,cart_id:mycart_id};
    if(addr_id){
        datas.addr_id=addr_id;
    };
    console.log(datas);
    //显示领券
    $('.corderlq').click(function () {
        console.log(123);
        $('#actionSheet_wrap2').css('display','block');
    });
    $('#mask2,#actionsheet_cancel2').click(function(){
        $('#actionSheet_wrap2').hide();
    });
    
    // 选择收货地址
    $('.cordertop').click(function(){
        var url="{:U('Address/selectaddress')}&type=2&cart_id="+mycart_id;
        window.location.href = url;
    })
    // 是否开豆支付
    $('.paytype').click(function(){
        console.log($('.paytype')[0].checked);
        if($('.paytype')[0].checked){
            $('.total').html("￥"+paynum.type);
            mydata.is_wallet=1;
        }else{
            $('.total').html("￥"+paynum.total);
            mydata.is_wallet=0;
        }
    });
    //点击支付
    $('.carfootr').click(function(){
        if (!isok) {
            return;
        }
        isok=false;
        $('.weui-textarea').each(function(){
            var that=$(this);
            var i = $(this).index();
            mydata.detail[i].remark=that.val();
        });
        mydata.detail = JSON.stringify(mydata.detail);
        mydata.cart_id = JSON.stringify(mydata.cart_id);
        if(coupon){
            mydata.cou_id = coupon.id;
        }
        console.log(mydata);
        requestUrl("{:U('Api/ProductOrder/addOrder')}",mydata,function(data){
            if(data.flag=="success"){
                console.log(data);
                if(mydata.is_wallet&&!paynum.type){
                    //豆支付
                    doupay(data.data.order_sn);
                }else{
                    hxpay(data.data.order_sn);
                }
                // location.href="{:U('Order/myorder')}&type=1";
            }else{
                layer.msg(data.message);
                isok=true;
            }
        },'POST',true);
    });
    //微信支付
    function hxpay(e){
        requestUrl("{:U('Pay/getHxShopOrderApi')}",{order_sn:e,type:0},function(data){
            if(data.flag=="success"){
                if(coupon){
                    sessionStorage.removeItem("couponarr");
                }
                console.log(data.data);
                document.getElementsByTagName("body")[0].innerHTML = data.data;
                document.forms['ipspaysubmit'].submit();
            }else{
                layer.msg(data.message);
            }
        },'POST',true);
    }
    //豆子支付
    function doupay(e){
        layer.open({
            content: '确认使用豆支付？'
            ,btn: ['立即支付', '稍后支付']
            ,yes: function(index, layero){
            //按钮【按钮一】的回调
                requestUrl("{:U('Api/BeanPay/BeanShopMixOrder')}",{order_sn:e,price:0},function(data){
                    if(data.flag=="success"){
                        console.log(data.data);
                        layer.msg('支付成功！');
                        if(coupon){
                            sessionStorage.removeItem("couponarr");
                        }
                        setTimeout(function(){
                            location.href="{:U('Order/myorder')}/type/2";
                        },1000);
                    }else{
                        layer.msg(data.message);
                    }
                },'POST',true);
            }
            ,btn2: function(index, layero){
                location.href="{:U('Order/myorder')}/type/1";
            }
            ,cancel: function(){ 
                location.href="{:U('Order/myorder')}/type/1";
            }
        });
    }
    requestUrl("{:U('Api/ProductOrder/firmOrder')}",datas,function(data){
        if(data.flag=="success"){
            var shops=data.data;
            mydata.addr_id=shops.address.addr_id;
            $('.name').html(shops.address.name);
            $('.tel').html(shops.address.phone);
            $('.address').html(shops.address.province+shops.address.city+shops.address.area+shops.address.address);
            $('.wallet').html(shops.wallet);
            paynum.oldtotal=shops.total;
            if(coupon){
                if(coupon.type==1){
                    if(shops.total<=coupon.money){
                        shops.total=0;
                    }else{
                       shops.total=(shops.total-coupon.money).toFixed(2);
                    }
                }else if(coupon.type==2){
                    if(shops.total>=coupon.max_price){
                        shops.total=(shops.total*coupon.money).toFixed(2);
                    }
                }else if(coupon.type==3){
                    if(shops.total>=coupon.max_price){
                        shops.total=(shops.total-coupon.money).toFixed(2);
                    }
                }
            }
            paynum.wallet=shops.wallet;
            paynum.total=shops.total;

            if(+shops.wallet>= +shops.total){
                $('.total').html('￥0');
                $('.dounum').html(shops.total);
                paynum.type=0;
            }else{
                console.log((shops.total-shops.wallet));
                $('.dounum').html(shops.wallet);
                paynum.type=(shops.total-shops.wallet).toFixed(2);
                $('.total').html('￥'+(paynum.type));
            }
            var str="";
            for(var index in shops.detail){
                var shop=shops.detail[index];
                var newstr="";
                var freight=0;//商品总运费
                mydata.detail.push({shop_id:shop.shop_id,product:[]});
                for(var i in shop.product){
                    mydata.cart_id.push(shop.product[i].cart_id);
                    freight+= +((+shop.product[i].postage)*(+shop.product[i].num)).toFixed(2);
                    newstr+='<div class="flex corderitemshop">'
                                +'<div class="carshopimg">'
                                    +'<img src="'+shop.product[i].cover_pic+'">'
                                +'</div>'
                                +'<div class="flex1 ih20 fs14">'
                                    +'<div class="carshoptab1">'
                                        +'<div class="line2 h40">'+shop.product[i].title+'</div>'
                                        +'<div class="colb6 fs12">'+((shop.product[i].attr_val&&shop.product[i].attr_val!="0")?shop.product[i].attr_val:"暂无属性")+'</div>'
                                        +'<div>'
                                            +'<span class="colred">￥'+shop.product[i].price+'</span>'
                                            +'<span class="right colb6">x'+shop.product[i].num+'</span>'
                                        +'</div>'
                                    +'</div>'
                                +'</div>'
                            +'</div>';
                    mydata.detail[index].product.push({ "cart_id":shop.product[i].cart_id,"num":shop.product[i].num,"price":shop.product[i].price, "p_id":shop.product[i].p_id,"attr":shop.product[i].attr_val,"attr_val_id":shop.product[i].attr_val_id});
                };
                mydata.detail[index].postage=freight;
                str+='<div class="corderitem mgb20 bgfff">'
                +'<div class="flex pad10 ih30">'
                    +'<div class="flex1 flex flexvcenter"><img class="w15 mgr5" src="/Public/Wechat/cusimg/img (6).png">'
                    +'<span>'+shop.shop_name+'</span></div>'
                    // +'<span class="corderlq">领券</span>'
                +'</div>'
                +'<div class="">'+newstr+'</div>'
                +'<div class="corderitemfoot fs14">'
                    +'<div class="weui-cell">'
                        +'<div class="weui-cell__bd">'
                            +'<p>配送方式</p>'
                        +'</div>'
                        +'<div class="weui-cell__ft"><span class="mgr5">快递</span>商品总运费￥<span>'+freight+'</span></div>'
                    +'</div>'
                    +'<div class="weui-cell">'
                        +'<div class="weui-cell__bd">'
                            +'<p>支付方式</p>'
                        +'</div>'
                        +'<div class="weui-cell__ft"><span>在线支付</span></div>'
                    +'</div>'
                    // +'<div class="weui-cell">'
                    //     +'<div class="weui-cell__bd">'
                    //         +'<p>优惠券</p>'
                    //     +'</div>'
                    //     +'<div class="weui-cell__ft"><span>暂无优惠券可用</span></div>'
                    // +'</div>'
                    +'<div class="weui-cell">'
                        +'<div class="weui-cell__bd">'
                            +'<textarea myid="'+shop.shop_id+'" class="weui-textarea" placeholder="买家留言(选填)" rows="3"></textarea>'
                        +'</div>'
                    +'</div>'
                    +'<div class="textright">'
                        +'<span class="mgr5">共'+shop.product_num+'件商品</span>'
                        +'小计:<span class="colred">￥'+shop.total+'</span>'
                    +'</div>'
                +'</div>'
            +'</div>';
            };
            $('.corderlist').append(str);   
        }else{
            layer.msg(data.message);
        }
    },"POST");

    //优惠券
    //显示优惠券
        $('.choosecoupon').click(function(){
            if(havenum==0){
                layer.msg('无其他可用优惠券');
                return;
            }
            $('#actionSheet_wrap2').show();
        });
        //关闭
        $('#mask2,#actionsheet_cancel2').click(function(){
            $('#actionSheet_wrap2').hide();
        });
    //使用优惠券
    var havenum=0;//剩几个优惠券
    $('.myweuilqmain').on('click','.lqright',function(){
        var c_m_id=$(this).attr('c_m_id');
        var $that=$(this);
        layer.open({
            content: '确定使用该优惠券？'
            ,btn: ['确定', '取消']
            ,yes: function(index, layero){
            //按钮【按钮一】的回调
                if($that.attr('type')==4){
                    requestUrl("{:U('Api/Coupon/useCoupon')}",{c_m_id:c_m_id},function(data){
                        if(data.flag=="success"){
                            layer.msg('使用成功！');
                        }else{
                            layer.msg(data.message);
                        }
                    },'POST',true);
                }else{
                        if($('.lqbox').length==0){
                            havenum=0;
                        }
                        if($that.attr('type')==1){
                            coupon={'id':c_m_id,'name':$that.attr('myname'),'money':$that.attr('money'),'type':1};
                            // couponarr.push(coupon);
                            // sessionStorage.setItem("couponarr",JSON.stringify(couponarr));
                        }else if($that.attr('type')==2){
                            coupon={'id':c_m_id,'name':$that.attr('myname'),'money':$that.attr('money'),'max_price':$that.attr('max_price'),'type':2};
                            // couponarr.push(coupon);
                            // sessionStorage.setItem("couponarr",JSON.stringify(couponarr));
                        }else if($that.attr('type')==3){
                            coupon={'id':c_m_id,'name':$that.attr('myname'),'money':$that.attr('money'),'max_price':$that.attr('max_price'),'type':3};
                            // couponarr.push(coupon);
                            // sessionStorage.setItem("couponarr",JSON.stringify(couponarr));
                        }
                        if(coupon){
                            coupon.isok=false;
                            if(coupon.type==1){
                                if(paynum.oldtotal<=coupon.money){
                                    paynum.total=0;
                                }else{
                                   paynum.total=(paynum.oldtotal-coupon.money).toFixed(2);
                                }
                                coupon.isok=true;
                            }else if(coupon.type==2){
                                if(paynum.oldtotal>=coupon.max_price){
                                    paynum.total=(paynum.oldtotal*coupon.money).toFixed(2);
                                    coupon.isok=true;
                                }
                            }else if(coupon.type==3){
                                if(paynum.oldtotal>=coupon.max_price){
                                    paynum.total=(paynum.oldtotal-coupon.money).toFixed(2);
                                    coupon.isok=true;
                                }
                            }
                        }
                        if(coupon.isok){
                            layer.msg('使用成功');
                            $that.closest('.lqbox').remove();
                             $('.couponname').html($that.attr('myname'));
                        }else{
                            layer.msg('优惠券条件不满足');
                            coupon="";
                        }
                            if(+paynum.wallet>= +paynum.total){ 
                                paynum.type=0;
                                $('.dounum').html(paynum.total);
                                if($('.paytype')[0].checked){
                                    $('.total').html('￥0');
                                }else{
                                    $('.total').html(paynum.total);
                                }
                            }else{
                                $('.dounum').html(paynum.wallet);
                                paynum.type=(paynum.total-paynum.wallet).toFixed(2);
                                if($('.paytype')[0].checked){
                                    $('.total').html('￥'+(paynum.type));
                                }else{
                                    $('.total').html(paynum.total);
                                }

                            }
                        
                }
                layer.close(index);
                $('#actionSheet_wrap2').hide();
            }
            ,btn2: function(index, layero){
                // location.href="{:U('Order/myorder')}/type/1";
            }
            ,cancel: function(){ 
                // location.href="{:U('Order/myorder')}/type/1";
            }
        });
    })
    //优惠券分页
    var dataargs2={m_id:m_id,status:1,p:1};
    getJson("shouci");
    function getJson(args) {
        console.log(dataargs2);
        requestUrl("{:U('Api/Coupon/couponList')}",dataargs2,function(data){
            layer.closeAll();
            putGoods(data,args);
        },"POST");
    };
    // var couponarr=[];//优惠券使用数组
    // if(sessionStorage.getItem("couponarr")){
    //         if(JSON.parse(sessionStorage.getItem("coupon")).shop_id==shop_id){
    //             couponarr=JSON.parse(sessionStorage.getItem("couponarr"));
    //             if(couponarr.length){
    //                 $('.choosecoupon').removeClass('none');
    //                 coupon=couponarr[couponarr.length-1];
    //                 $('.couponname').text(coupon.name);
                    
    //             }
    //         }
    // } 
    //添加商品到列表
    function putGoods(data,args) {
        console.log(data);
        if(data.flag == 'success'){
            var shops = data.data;
            if((!shops || shops.length == 0 ) && args == "shouci"){
                $(".myweuilqmain>div").html('');
                $(".nomore").remove();
            }else if((!shops || shops.length == 0 ) && args == "fenye"){
                $(".myweuilqmain>div").append('<div class="texcen nomore">没有更多了！</div>');
            }else{
                havenum=1;
                $('.choosecoupon').removeClass('none');
                $(".nomore").remove();
                var str ="";
                for(var index in shops){
                    var shop = shops[index];
                    if( +shop.status==0){
                        // 判断状态
                        var newstr="";//存储状态
                        switch(+shop.type)
                        {
                        case 1:
                            newstr='<div class="flex lqbox lqbox3">'
                                        +'<div class="flex1 flex lqleft textovh">'
                                            +'<div class="flex flexcenter mgr5">'
                                                +'￥ <span class="fs35">'+shop.min_price+'</span>'
                                            +'</div>'
                                            +'<div class="flex1 textovh fs14">'
                                                +'<div>'+shop.title+'</div>'
                                                +'<div class="textovh">'+shop.desc+'</div>'
                                                +'<div class="fs12 textovh">(<span>'+shop.start_time+'-'+shop.end_time+'</span><span></span>)</div>'
                                            +'</div>'
                                        +'</div>'
                                        +'<div class="lqright flex flexcenter" money="'+shop.min_price+'" type="'+shop.type+'" myname="'+shop.title+'" c_m_id='+shop.c_m_id+'>'
                                            +'<span class="">点击使用</span>'
                                        +'</div>'
                                    +'</div>'
                            break;
                        case 2:
                            newstr='<div class="flex lqbox lqbox2">'
                                        +'<div class="flex1 flex lqleft textovh">'
                                            +'<div class="flex flexcenter mgr5">'
                                                +'<span class="fs35">'+shop.money+'</span>'
                                                +'<span class="y3">折</span>'
                                            +'</div>'
                                            +'<div class="flex1 textovh fs14">'
                                                +'<div>'+shop.title+'</div>'
                                                +'<div class="textovh">'+shop.desc+'</div>'
                                                +'<div class="fs12 textovh">(<span>'+shop.start_time+'-'+shop.end_time+'</span><span></span>)</div>'
                                            +'</div>'
                                        +'</div>'
                                        +'<div class="lqright flex flexcenter" max_price="'+(shop.max_price?shop.max_price:0)+'" money="'+shop.money/10+'" type="'+shop.type+'" myname="'+shop.title+'" c_m_id='+shop.c_m_id+'>'
                                            +'<span class="">点击使用</span>'
                                        +'</div>'
                                    +'</div>'
                            break;

                        case 3:
                            newstr='<div class="flex lqbox lqbox1">'
                                        +'<div class="flex1 flex lqleft textovh">'
                                            +'<div class="flex flexcenter mgr5">'
                                                +'￥ <span class="fs35">'+shop.min_price+'</span>'
                                            +'</div>'
                                            +'<div class="flex1 textovh fs14">'
                                                +'<div>'+shop.title+'</div>'
                                                +'<div class="textovh">'+shop.desc+'</div>'
                                                +'<div class="fs12 textovh">(<span>'+shop.start_time+'-'+shop.end_time+'</span><span></span>)</div>'
                                            +'</div>'
                                        +'</div>'
                                        +'<div class="lqright flex flexcenter" max_price="'+shop.max_price+'" type="'+shop.type+'" money="'+shop.min_price+'" myname="'+shop.title+'" c_m_id='+shop.c_m_id+'>'
                                            +'<span class="">点击使用</span>'
                                        +'</div>'
                                    +'</div>'
                            break;

                        case 4:
                            newstr='<div class="flex lqbox lqbox4">'
                                        +'<div class="flex1 flex lqleft textovh">'
                                            +'<div class="flex flexcenter mgr5">'
                                                +'￥ <span class="fs35">免</span>'
                                            +'</div>'
                                            +'<div class="flex1 textovh fs14">'
                                                +'<div>'+shop.title+'</div>'
                                                +'<div class="textovh">'+shop.desc+'</div>'
                                                +'<div class="fs12 textovh">(<span>'+shop.start_time+'-'+shop.end_time+'</span><span></span>)</div>'
                                            +'</div>'
                                        +'</div>'
                                        +'<div class="lqright flex flexcenter" type="'+shop.type+'" myname="'+shop.title+'" c_m_id='+shop.c_m_id+'>'
                                            +'<span class="">点击使用</span>'
                                        +'</div>'
                                    +'</div>'
                            break;

                        }
                        str +=newstr;
                    }
                }
                if (args == "fenye") {
                    $('.myweuilqmain>div').append(str);
                }else{
                    $('.myweuilqmain>div').html(str);
                }
                flag2=true;
                top_linkto();
            }
        }else{
            layer.msg(data.message);
            $(".myweuilqmain>div").html('').addClass('wusj');
        }
        if (args == "shouci") {
            fenye();
        }
    }

    var flag2=true;
    function fenye(){
        var $_zd = $(".lqbox").height();//获取每个单项的高度
        var length = 3;//定义预加载的数量，提前三个加载数据
        var $_par = $(".myweuilqmain>div");//获取包裹容器
        var winheight = 250;//获取窗口高度
        var curpage = 1;//存储当前的页数v
        $(function(){
            $('.myweuilqmain').on("scroll",function(e){
                if(flag2){
                    var self = $(this);
                    var scrtop = self.scrollTop() + winheight;
                    var docheight = $_par.height();
                    //console.log(scrtop + "=" + docheight + "=" + $_zd);
                    if(scrtop > docheight - ( length * $_zd ) ){
                        flag2 = false;
                        dataargs2.p = dataargs2.p +1;
                        getJson("fenye");
                    }
                }
            });
        });
    }
</script>
<script type="text/javascript">
    function setupWebViewJavascriptBridge(callback) {
            if (window.WebViewJavascriptBridge) {
                return callback(WebViewJavascriptBridge); }
            if (window.WVJBCallbacks) {
                return window.WVJBCallbacks.push(callback); }
            if (!window.WebViewJavascriptBridge) {
                document.addEventListener(
                        'WebViewJavascriptBridgeReady'
                        , function() {
                            callback(WebViewJavascriptBridge)
                        },
                        false
                );
            }
            window.WVJBCallbacks = [callback];
            var WVJBIframe = document.createElement('iframe');
            WVJBIframe.style.display = 'none';
            WVJBIframe.src = 'https://__bridge_loaded__';
            document.documentElement.appendChild(WVJBIframe);
            setTimeout(function() { document.documentElement.removeChild(WVJBIframe) }, 0)
    }

    setupWebViewJavascriptBridge(function(bridge) {
            $(".carfootr").off('click');
            $(".carfootr").on('click',function ( e ) {
                e.preventDefault();
                if (!isok) {
                    return;
                }
                isok=false;
                $('.weui-textarea').each(function(){
                    var that=$(this);
                    var i = $(this).index();
                    mydata.detail[i].remark=that.val();
                });
                mydata.detail = JSON.stringify(mydata.detail);
                mydata.cart_id = JSON.stringify(mydata.cart_id);
                console.log(mydata);
                if(coupon){
                    mydata.cou_id = coupon.id;
                }
                requestUrl("{:U('Api/ProductOrder/addOrder')}",mydata,function(data){
                    if(data.flag=="success"){
                        console.log(data);
                        if(mydata.is_wallet&&!paynum.type){
                            //豆支付
                            doupay(data.data.order_sn);
                        }else{
                            // hxpay(data.data.order_sn);
                            if( +paynum.type>30000){
                                layer.msg('实际支付金额大于30000<br>请分开支付');
                                isok=true;
                                return;
                            };
                            layer.msg("正在唤起微信！");
                            bridge.callHandler('loginAction2',{order_sn:data.data.order_sn,type:0}, function(response) {
                                //处理oc过来的回调
                                if(coupon){
                                    sessionStorage.removeItem("couponarr");
                                }
                                layer.closeAll();
                            });
                        }
                        // location.href="{:U('Order/myorder')}&type=1";
                    }else{
                        layer.msg(data.flag);
                        isok=true;
                    }
                },'POST',true);
            });
    });
</script>
</block>