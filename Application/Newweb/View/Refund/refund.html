<extend name="Public:head"/>
<block name="main">
	<!-- 头部 -->
    <div class="header-container bgfff z5">
            <div class="weui-cell ih30 box">
                <div class="weui-cell__hd">
                </div>
                <div class="weui-cell__bd re textcenter">
                    <!-- <div class="addressback" linkto="javascript:history.go(-1);"><img class="w100" src="__WEBPUBLIC__/Wechat/img/back.png"></div> -->
                	<span class="headname">申请退款</span>
                    <!-- <span class="colon addressgl">管理</span> -->
                </div>
                <!--<div class="weui-cell__ft">
                    <img src="/Public/Wechat/img/fenx.png" class="iconfenx"/>
                </div>-->
            </div>
    </div>
    <!-- 内容 -->
    <div class="xq_container">
    	<div class="pad10 flex bgfff">
            <div class="returnimgbox mgr5"><img class="getimg" src=""></div>   
            <div class="flex1">
                <div class="line2 getname"></div>
                <div class="colb6 attrname"></div>
            </div>   
        </div>
        <!-- 退款 -->
        <div>
            <div class="weui-cells">
                <!-- 退货退款 -->
                <a class="weui-cell weui-cell_access lookgoodsstate none" href="javascript:;">
                    <div class="weui-cell__bd">
                        <div>货物状态</div>
                    </div>
                    <div class="weui-cell__ft hwzt">已到货</div>
                </a>

                <a class="weui-cell weui-cell_access refundsreasons" href="javascript:;">
                    <div class="weui-cell__bd">
                        <div>退款原因</div>
                    </div>
                    <div class="weui-cell__ft tkyy textovh">请选择</div>
                </a>
            </div>
            <div class="pad10 mgtop10 bgfff">
                <div><span>退款金额(￥):</span><span class="colred right price">0</span></div>
                <div><input class="returnmoneyinp" placeholder="最多￥34.90" type="number" name=""></div>
            </div>
            <div class="bgfff mgtop10">
                <div class="pad10 ih30"><span class="mgr5">退款说明</span><span class="colb6">选填</span></div>
                <div class="weui-cell">
                    <div class="weui-cell__bd">
                        <textarea class="weui-textarea" placeholder="请输入退款说明" rows="3"></textarea>
                    </div>
                </div>
            </div>
            <div class="mgtop10 bgfff pad10">
                <div class="weui-uploader__hd">
                    <p class="fs17 weui-uploader__title">上传凭证</p>
                </div>
                <div class="weui-uploader__bd">
                    <ul class="weui-uploader__files" id="uploaderFiles">
                        
                    </ul>
                    <div class="weui-uploader__input-box imgbox1 returninpbgimg">
                        <input id="uploaderInput" onchange="mychange(this)" class="weui-uploader__input backinp" type="file" accept="image/*" multiple />
                    </div>
                 </div>
            </div>
        </div>
    </div>

    <div class="returnfoot z5">
        提交
    </div>

    <!-- 查看货物状态 -->
        <div id="actionSheet_wrap" class="returnaction2" style="display: none;">
            <div class="weui-mask_transparent actionsheet__mask bg0-6"  style="opacity: 1" id="mask"></div>
            <div class="weui-actionsheet weui-actionsheet_toggle" id="weui-actionsheet">
                <div class="weui-actionsheet__menu">
                    <div class="weuimenutop after pad10 ih30 textcenter returnactiontop1">货物状态</div>
                    <div class="weuimenutop after pad10 ih30 textcenter returnactiontop2">退款原因</div>
                    <div class="returnactionmain1">
                        <div class="weui-cells nocells weui-cells_radio">
                            <label class="weui-cell weui-check__label" for="x10">
                                <div class="weui-cell__bd">
                                    <p>未到货</p>
                                </div>
                                <div class="weui-cell__ft">
                                    <input myattr="未到货" type="radio" class="weui-check" name="radio1" id="x10">
                                    <span class="weui-icon-checked"></span>
                                </div>
                            </label>
                            <label class="weui-cell weui-check__label" for="x12">

                                <div class="weui-cell__bd">
                                    <p>已到货</p>
                                </div>
                                <div class="weui-cell__ft">
                                    <input myattr="已到货" type="radio" name="radio1" class="weui-check" id="x12" checked="checked">
                                    <span class="weui-icon-checked"></span>
                                </div>
                            </label>
                        </div>
                    </div>
                    <div class="returnactionmain2">
                        <div class="weui-cells nocells weui-cells_radio">
                            <!-- <label class="weui-cell weui-check__label" for="x11">
                                <div class="weui-cell__bd">
                                    <p>多拍/错拍/不想要</p>
                                </div>
                                <div class="weui-cell__ft">
                                    <input type="radio" class="weui-check" name="radio1" id="x11">
                                    <span class="weui-icon-checked"></span>
                                </div>
                            </label>
                            <label class="weui-cell weui-check__label" for="x12">
                                <div class="weui-cell__bd">
                                    <p>其他原因</p>
                                </div>
                                <div class="weui-cell__ft">
                                    <input type="radio" name="radio1" class="weui-check" id="x12" checked="checked">
                                    <span class="weui-icon-checked"></span>
                                </div>
                            </label> -->
                        </div>
                    </div>
                </div>
                <div class="weui-actionsheet__action">
                    <div class="weui-actionsheet__cell" id="actionsheet_cancel">确定</div>
                </div>
            </div>
        </div>

</block>
<block name="footerjs">
<script type="text/javascript">
    var type="{$_GET['type']}";//type=1,仅退款type=2，退货退款
    var status="{$_GET['status']}";//进来的方式，为2表示修改申请 
    var return_id="{$_GET['return_id']}";
    var order_id="{$_GET['order_id']}";
    var p_id="{$_GET['p_id']}";
    var shop_id="{$_GET['shop_id']}";
    var attr_group="{$_GET['attr_group']}";
    var price="";//最多金额
    var mydata={m_id:m_id,order_id:order_id,goods_id:p_id,shop_id:shop_id};//参数
    if(type==1){
        $('.lookgoodsstate').removeClass('none');
    }else{

    };
    //如果是ios
    if((isApp)&&!!navigator.userAgent.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/)){
        $('.xq_container').addClass('app_xq_container');
        $('.app_xq_container').removeClass('xq_container');
    }
    var datajson={order_id:order_id,p_id:p_id,attr_group:attr_group};
    if(status==2){
        mydata={return_id:return_id};
        $('.headname').html('修改退款申请');
        $('.returnfoot').html('确认修改');
        datajson.return_id=return_id;
    };
    var data2={};   //修改申请需要显示的数据
        requestUrl("{:U('Api/ReturnOrder/returnGoodsMess')}",datajson,function(data){
                if(data['flag'] == "success"){
                    var shops=data.data;
                   $('.getimg').attr('src',shops.cover_pic);
                   $('.getname').html(shops.title);
                   $('.attrname').html((shops.attr_val&&shops.attr_val!="0")?shops.attr_val:"暂无属性");
                   if(status!=2){
                      mydata.attr_val=shops.attr_val;  
                   }else{
                        $('.weui-textarea').val(shops.remark);
                        $('.returnmoneyinp').val(shops.return_price);
                        data2.reason=shops.reason;
                        for(var k in shops.pic){
                            imgarr.push(shops.pic[k]);
                            $('#uploaderFiles').append('<li class="weui-uploader__file myimgli" style="background-image:url(https://m.zxty.me/'+shops.pic[k]+')"><span class="imgremove" style="color:red">X</span></li>');
                        }
                        if(imgarr.length>=3){
                            $('.imgbox1.weui-uploader__input-box').hide();
                        }
                   };
                   $('.price').html(shops.price.toFixed(2));
                   $('.returnmoneyinp').attr('placeholder','最多￥'+shops.price.toFixed(2));
                   price=shops.price.toFixed(2);
                }else if(data['flag'] == "error"){
                    layer.msg(data['message']);
                }
        },"POST",true); 
    
    if(navigator.userAgent.indexOf('android')!=-1){
        $('.backinp').attr('capture','camera');
    }

    $('.returnmoneyinp').keyup(function(){
        var num=$(this).val();
        console.log(num);
        if(num> +price){
            layer.msg('最多￥'+price);
            $(this).val(price);
        };
    });

    $('.returnfoot').click(function(){
        var num=$.trim($('.returnmoneyinp').val());
        if(!num){
            layer.msg('金额不能为空！');
            return ;
        };
        // if(!imgarr.length){
        //     layer.msg('请上传凭证');
        //     return ;
        // };
        if(imgarr.length){
           mydata.pic=imgarr;
        };
        if(!$('.returnactionmain2 .weui-cell').length){
            layer.msg('选择退款原因');
            return;
        };
        mydata.price=num;
        if($.trim($('.weui-textarea').val())){
            mydata.remark=$('.weui-textarea').val();
        };
        mydata.return_status=(type==1?"仅退款":"退货退款");
        mydata.reason=$('.returnactionmain2 input:checked').parents('label').find('.weui-cell__bd p').html();
        mydata.goods_status=$('.returnactionmain1 input:checked').attr('myattr');
        if(status==2){
            requestUrl("{:U('Api/ReturnOrder/editReturnOrder')}",mydata,function(data){
                if(data['flag'] == "success"){
                    layer.msg('申请成功');
                    setTimeout(function(){
                        var url="{:U('Refund/refundlist')}"+(isApp?'/isApp/'+isApp:'');
                        location.href=url;
                    },1500);
                }else if(data['flag'] == "error"){
                    layer.msg(data['message']);
                }
            },"POST",true);
        }else{
            requestUrl("{:U('Api/ReturnOrder/returnMethod')}",mydata,function(data){
                if(data['flag'] == "success"){
                    layer.msg('申请成功');
                    setTimeout(function(){
                        var url="{:U('Refund/refundlist')}"+(isApp?'/isApp/'+isApp:'') ;
                        location.href=url;
                    },1500);
                }else if(data['flag'] == "error"){
                    layer.msg(data['message']);
                }
            },"POST",true);
        };
           
    });
    $('.returnactionmain1 label').click(function(){
        console.log("进入");
        var that=$(this);
        $('.hwzt').html(that.find('.weui-cell__bd p').html());

    });
    $('.returnactionmain2').on('click','label',function(){
        var that=$(this);
        console.log(that.find('.weui-cell__bd p').html());
        console.log($('.tkyy'));
        $('.tkyy').html(that.find('.weui-cell__bd p').html());
    });

	// 图片数组
    var imgarr=[];
    // 点击添加多图图片
    function mychange (data) {
        var fileimg=data.files; 
        var arrnum=imgarr.length;
        var num=arrnum+fileimg.length;
        if(num>3){
            layer.msg("最多上传三张图片");
            return false;
        };
        for(var i =0;i<fileimg.length;i++){    
            /*图片转Base64 核心代码*/  
            var file = fileimg[i];  
            //这里我们判断下类型如果不是图片就返回 去掉就可以上传任意文件  
            if (!/image\/\w+/.test(file.type)) {  
                layer.msg("请确保文件为图像类型");  
                return false;  
            }  
            var reader = new FileReader(); 
            (function(x){
                    reader.onload = function (e) {  
                    var str='<li class="weui-uploader__file myimgli" style="background-image:url('+this.result+')"><span class="imgremove" style="color:red">X</span></li>';
                    $("#uploaderFiles").append(str);
                    if(num==3){
                        $('.imgbox1.weui-uploader__input-box').hide();
                    }
                    render(this.result,x);
                    }  
            })(file.name) 
            
            reader.readAsDataURL(file);  
        }
    };


var MAX_HEIGHT = 1000;
// 渲染
function render(src,picname,datanum) {
    // 创建一个 Image 对象
    var image = new Image();
    // 绑定 load 事件处理器，加载完成后执行
    image.onload = function() {
        // 获取 canvas DOM 对象
        var canvas = document.createElement("canvas");
        // 如果高度超标
        if (image.height > MAX_HEIGHT && image.height >= image.width) {
            // 宽度等比例缩放 *=
            image.width *= MAX_HEIGHT / image.height;
            image.height = MAX_HEIGHT;
        }
        if (image.width > MAX_HEIGHT && image.width > image.height) {
            // 宽度等比例缩放 *=
            image.height *= MAX_HEIGHT / image.width;
            image.width = MAX_HEIGHT;
        }
        // 获取 canvas的 2d 环境对象,
        // 可以理解Context是管理员，canvas是房子
        var ctx = canvas.getContext("2d");
        // canvas清屏
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        // 重置canvas宽高
        canvas.width = image.width;
        canvas.height = image.height;
        // 将图像绘制到canvas上
        ctx.drawImage(image, 0, 0, image.width, image.height);
        // !!! 注意，image 没有加入到 dom之中
//        document.getElementById('img').src = canvas.toDataURL("image/png");
        var blob = canvas.toDataURL("image/jpeg");
        // if(datanum==1){
           
        // }else{
        //     imgarr.push({"pic":blob,"pic_name":picname});
           
        // }
        upimg({"pic":blob,"pic_name":picname});
        // imgarr.push({"pic":blob,"pic_name":picname});
        // var fd = new FormData();
        // fd.append("image", blob, "image.png");
        // imgCompressUpload(canvas.toDataURL("image/png"));
       
    };
    // 设置src属性，浏览器会自动加载。
    // 记住必须先绑定事件，才能设置src属性，否则会出同步问题。
    image.src = src;
};  
    //上传图片
    function upimg(e){
        requestUrl("{:U('Empty/uploadPicReturn')}",e,function(data){
                if(data['flag'] == "success"){
                    imgarr.push(data.data.path);   
                }else if(data['flag'] == "error"){
                    layer.msg(data['message']);
                }
        },"POST");
    }
    // 点击删除图片
    $("#uploaderFiles").on("click",".imgremove",function(){
        $(this).parent().remove();
        $("#uploaderInput").remove();
        var str="<input id='uploaderInput' onchange='mychange(this)' class='weui-uploader__input' type='file' accept='image/*' multiple />";
        $(".weui-uploader__input-box.imgbox1").append(str).show();
        imgarr.splice($(this).index()-1,1); 
    });

    // 点查看货物状态
    $('.lookgoodsstate').click(function () {
        $('#actionSheet_wrap').css('display','block').removeClass('returnaction2');
    });
    $('#mask,#actionsheet_cancel').click(function(){
        $('#actionSheet_wrap').hide();
    });

    requestUrl("{:U('Api/ReturnOrder/returnReason')}",{},function(data){
                if(data['flag'] == "success"){
                    var shops=data.data;
                    var str="";
                    for(var i in shops){
                        str+='<label class="weui-cell weui-check__label" for="'+shops[i].id+'">'
                                +'<div class="weui-cell__bd">'
                                    +'<p>'+shops[i].title+'</p>'
                                +'</div>'
                                +'<div class="weui-cell__ft">'
                                    +'<input type="radio" text="'+shops[i].title+'" class="weui-check ttyyinp" '+(status==2?(data2.reason==shops[i].title?"checked='checked'":""):(i==0?"checked='checked'":""))+' name="radio2" value="'+shops[i].id+'" id="'+shops[i].id+'">'
                                    +'<span class="weui-icon-checked"></span>'
                                +'</div>'
                            +'</label>';
                    };
                    $('.returnactionmain2 .weui-cells').html(str);
                    $('.tkyy').html($('.ttyyinp:checked').attr('text'));
                }else if(data['flag'] == "error"){
                    layer.msg(data['message']);
                }
        },"GET",true);
    //点击退款原因
    $('.refundsreasons').click(function () {
        $('#actionSheet_wrap').css('display','block').addClass('returnaction2');
    });
</script>
</block>