<include file="Public:header"/>
<!--主页面-->
<div id="main-content" class="content">
    <ul class="breadcrumb">
        <li><a href="{:U('Index/main')}">首页</a></li>
        <li class="active"><a href="">商品管理</a></li>
        <li class="active">商品列表</li>
    </ul>

    <div class="page-header page-header1 clearfix">
        <h3>商品管理</h3>
        <ul class="nav nav-tabs">
            <li class="">
                <a href="{:U('Goods/goodsList')}">商品列表</a>
            </li>
            <li class="active">
                <a href="{:U('Goods/addGoods')}">添加商品</a>
            </li>
        </ul>
    </div>
        <!--表格内容-->
        <div class="content-box-content">
            <!--表单 start-->
            <form action="{:U('Goods/addGoods')}" method="post" class="form-horizontal form"  enctype="multipart/form-data">
                <div class="form-group">
                    <label for="" class="col-sm-3 control-label"><em class="prompt-red">*</em>商品名称：</label>
                    <div class="col-sm-6">
                        <input type="text" class="form-control goods"  name="name" placeholder="商品名称">
                    </div>
                </div>
                <div class="form-group">
                    <label for="" class="col-sm-3 control-label"><em class="prompt-red">*</em>商品所需（麦穗/众享豆）：</label>
                    <div class="col-sm-6">
                        <input type="text" class="form-control shoe-quantity"  name="price" placeholder="商品所需（麦穗/众享豆）">
                    </div>
                </div>
                <div class="form-group">
                    <label for="" class="col-sm-3 control-label"><em class="prompt-red">*</em>商品邮费：</label>
                    <div class="col-sm-6">
                        <input type="text" class="form-control shoe-quantity"  name="freight" placeholder="商品邮费">
                    </div>
                </div>
                <div class="form-group">
                    <label for="" class="col-sm-3 control-label"><em class="prompt-red">*</em>商品分类：</label>
                    <div class="col-sm-9">
                        <select name="cate_id" id="type_id" class="form-control input-small form-control-select">
                            <option value="">请选择商品分类...</option>
                            <volist name="list" id="vo">
                                <option value="{$vo['cate_id']}">{$vo['category']}</option>
                            </volist>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="" class="col-sm-3 control-label">商品单位：</label>
                    <div class="col-sm-6">
                        <input type="text" class="form-control shoe-quantity"  name="unit" placeholder="商品单位">
                    </div>
                </div>
                <div class="form-group">
                    <label for="" class="col-sm-3 control-label">商品销量：</label>
                    <div class="col-sm-6">
                        <input type="text" class="form-control shoe-quantity"  name="sales" placeholder="商品销量">
                    </div>
                </div>
                <div class="form-group">
                    <label for="" class="col-sm-3 control-label">商品排序：</label>
                    <div class="col-sm-6">
                        <input type="number" class="form-control shoe-quantity"  name="sort" placeholder="商品排序">
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-3 control-label">商品链接地址：</label>
                    <div class="col-sm-6">
                        <input type="text" class="form-control shoe-quantity"  name="link_url" placeholder="商品链接地址" >
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-3 control-label">是否顺丰发货：</label>
                    <div class="col-sm-6">
                        <span>是：<input type="radio" class=""  name="is_send" value="1" >&nbsp;&nbsp;
                        否：<input type="radio" class=""  name="is_send" value="0" ></span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="desc" class="col-sm-3 control-label"><em class="prompt-red">*</em>商品描述：</label>
                    <div class="col-sm-9">
                        <textarea name="desc" class="form-control" id="desc" style="width:auto;height:300px;visibility:hidden;" ></textarea>
                    </div>
                </div>
                <div class="form-group">
                    <label for="" class="col-sm-3 control-label">是否显示首页：</label>
                    <div class="col-sm-6">
                        <span>是：<input type="radio" class=""  name="is_show" value="1" checked>&nbsp;&nbsp;
                        否：<input type="radio" class=""  name="is_show" value="0"></span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="" class="col-sm-3 control-label">商品类型：</label>
                    <div class="col-sm-6">
                        <span>麦穗商品：<input type="radio" class=""  name="type" value="1" checked>&nbsp;&nbsp;
                        <!--豆商品：<input type="radio" class=""  name="type" value="0">--></span>
                    </div>
                </div>
                <!--<div class="form-group">-->
                    <!--<label for="" class="col-sm-3 control-label">是否显示首页：</label>-->
                    <!--<div class="col-sm-6">-->
                        <!--<span>是：<input type="radio" class=""  name="is_index" value="1" checked>&nbsp;&nbsp;-->
                        <!--否：<input type="radio" class=""  name="is_index" value="0"></span>-->
                    <!--</div>-->
                <!--</div>-->
                <div class="form-group">
                    <label class="col-sm-3 control-label"><em class="prompt-red">*</em>商品封面图片：</label>
                    <div id="imgPreview">

                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label"></label>
                    <div class="col-sm-5">
                        <input type="file" name="head_pic_upload"/>
                    </div>
                    <div class="col-sm-5">
                        <input type="text" class="singelimg"/>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-3 control-label"><em class="prompt-red">*</em>商品的多图展示：</label>
                    <div id="imgPreviewMore">

                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label"></label>
                    <div class="col-sm-5">
                        <input type="file" name="pic_upload" multiple/>
                        <span style="color: red">框选上传多张图片</span>
                    </div>
                    <div class="col-sm-5">
                        <input type="text" class="playimg"/>
                    </div>
                </div>

                <div class="form-group">
                    <div class="col-sm-offset-3 col-sm-9">
                        <button type="button" class="btn btn-default btn-primary add-to-here make_sure">确认添加</button>
                    </div>
                </div>
            </form>
            <!--表单 end-->
        </div>
    </div>
</div>
<include file="Public:footer"/>
<!--商品的封面图和商品的多图的展示-->
<script>
    $(".playimg").on('change',function () {
        var imgsrc = $(this).val().split(",");
        imgsrc.forEach(function (val,idx) {
                $("#imgPreviewMore").append("<div class='parents' style='float: left'>" +
                                    "<div class='two_del'>[-]</div>" +
                                    "<input type='hidden' value='"+val+"' name='pic[]'/>"+
                                    "<div><img src='"+val+"' style='width: 150px;'></div></div>");
        });
    })

    $(".singelimg").on('change',function () {
        var imgsrc = $(this).val().split(",");
        if (imgsrc.length>1) {
            layer.msg("默认取第一张！");
        }
        $("#imgPreview").append(" <div class='parents'><div class='two_del'>[-]</div><input type='hidden' value='"+imgsrc[0]+"' name='cover_pic'/>"+
                                    "<div><img src='"+imgsrc[0]+"' style='width: 150px;'></div></div>");
    });

    $("#imgPreview,#imgPreviewMore").on('click','.two_del',function(){
        $(this).parent().remove();
    });
    $(".make_sure").click(function () {
        var name = $('input[name="name"]').val();
        var price = $('input[name="price"]').val();
        var freight = $('input[name="freight"]').val();
        var desc = $('textarea[name="desc"]').val();
        if(!name){
            alert("商品名称不能为空!");return false;
        }
        if(!price){
            alert("商品的价格不能为空!");return false;
        }
        if(!freight){
            alert("商品的配送费不能为空!");return false;
        }
        if(!desc){
            alert("商品的描述不能为空!");return false;
        }
        $(".form").submit();
    })


    function ajax(){
        var filesize = this.files[0].size;
        if (filesize > 10000*1024) {
            alert("请上传大小在500k以下的图片");
            return false;
        }
        var files = this.files;
        var i = '';
        for(i=0;files.length;i++){
            var picname = files[i].name;
            var reader = new FileReader();
            reader.onload = function(e){
                var src = e.target.result;
                $.ajax({
                    type:"post",
                    url:"{:U('Goods/uploadPic')}",
                    data: {"pic":src,"pic_name":picname},
                    dataType : "json",
                    success : function(data){
                        var data = JSON.parse(data);
                        if(data['flag'] == "success"){
                            $("#imgPreview").append(" <div class='parents'><div class='one_del'>[-]</div><input type='hidden' value='"+data['data']['path']+"' name='cover_pic'/>"+
                                    "<div><img src='"+'/'+data['data']['path']+"' style='width: 150px;'></div></div>");
                            bindClick();
                        }
                    }
                });
            }
            reader.readAsDataURL(files[i]);
        }
    }
    $("input[name='head_pic_upload']").on('change',ajax);
    function bindClick() {
        $(".one_del").click(function () {
            var url = "{:U('Goods/delPhoto')}";
            var file_path = $(this).next().val();
            $.post(url,{file_path:file_path},function(data){
                if(data == 1){
                    $("#imgPreview").html("");
                }else{
                    alert("删除失败！请重新尝试！");
                }
            })
        })
    }
    bindClick();



    function ajax1(){
        var filesize = this.files[0].size;
        if (filesize > 10000*1024) {
            alert("请上传大小在500k以下的图片");
            return false;
        }
        var files = this.files;
        var i = '';
        for(i=0;files.length;i++){
            var picname = files[i].name;
            var reader = new FileReader();
            reader.onload = function(e){
                var src = e.target.result;
                $.ajax({
                    type:"post",
                    url:"{:U('Goods/uploadPic')}",
                    data: {"pic":src,"pic_name":picname},
                    dataType : "json",
                    success : function(data){
                        var data = JSON.parse(data);
                        if(data['flag'] == "success"){
                            $("#imgPreviewMore").append("<div class='parents' style='float: left'>" +
                                    "<div class='one_more_del'>[-]</div>" +
                                    "<input type='hidden' value='"+data['data']['path']+"' name='pic[]'/>"+
                                    "<div><img src='"+'/'+data['data']['path']+"' style='width: 150px;'></div></div>");
                        }
                        bindClickMore();
                    }
                });
            }
            reader.readAsDataURL(files[i]);
        }
    }
    $("input[name='pic_upload']").on('change',ajax1);

    function bindClickMore() {
        $(".one_more_del").off("click");
        $(".one_more_del").click(function () {
            var url = "{:U('Goods/delPhoto')}";
            var file_path = $(this).next().val();
            $.post(url,{file_path:file_path},function(data){
                if(data == 1){
                    $(this).parent().remove();
                }else{
                    alert("删除失败！请重新尝试！");
                }
            }.bind(this))
        })
    }
    bindClickMore();

</script>

<script  src="__WEBPUBLIC__/Common/kindeditor/kindeditor-min.js"></script>
<script  src="__WEBPUBLIC__/Common/kindeditor/lang/zh_CN.js"></script>
<script>
    var editor;
    KindEditor.ready(function(K) {
        editor = K.create('textarea[name="desc"]', {
            resizeType : 1,
            uploadJson : '__WEBPUBLIC__/Common/kindeditor/php/upload_json.php',
            fileManagerJson :
                    '__WEBPUBLIC__/Common/kindeditor/php/file_manager_json.php',
            allowPreviewEmoticons : false,
            items:[
                'source', '|', 'undo', 'redo', '|', 'cut', 'copy','|', 'justifyleft',
                'justifycenter', 'justifyright',
                'justifyfull', 'clearhtml', 'selectall', '|', 'formatblock',
                'fontname', 'fontsize', '|', 'forecolor',
                'hilitecolor', 'bold', 'italic', 'underline', 'strikethrough','image','multiimage'
            ],
            afterBlur:function(){this.sync();}
        });
    });
</script>
